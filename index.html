<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta de Refei√ß√µes</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --energisa-blue: #0097CE;
  --energisa-blue-dark: #0079a6;
  --bg-soft: #f5f7fa;
}

body {
  background: var(--bg-soft);
  padding: 16px;
}

.card {
  border-radius: 14px;
  border: none;
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
}

.header-title {
  background: var(--energisa-blue);
  padding: 14px;
  color: white;
  border-radius: 12px;
  text-align: center;
  font-size: 1.4rem;
  font-weight: bold;
  margin-bottom: 20px;
}

/* ===== CALEND√ÅRIO ===== */
.calendario-wrapper {
  text-align: center;
}

.calendario-titulo {
  font-size: 1.3rem;
  font-weight: bold;
  margin-bottom: 15px;
  color: var(--energisa-blue-dark);
}

.calendario {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.dia {
  padding: 8px;
  border-radius: 10px;
  background: #f1f3f5;
  text-align: center;
  font-weight: 600;
  min-height: 70px;
  cursor: pointer;
  font-size: 14px;
}

.dia.registrado {
  background: var(--energisa-blue);
  color: white;
}

.refeicao {
  display: block;
  font-size: 11px;
  margin-top: 4px;
  font-weight: normal;
}

/* ===== MOBILE ===== */
@media (max-width: 576px) {
  .calendario {
    gap: 6px;
  }

  .dia {
    min-height: 55px;
    font-size: 13px;
    padding: 6px;
  }

  .refeicao {
    font-size: 10px;
  }

  .calendario-titulo {
    font-size: 1.1rem;
  }
}
</style>
</head>

<body>

<div class="container">

  <div class="header-title">üìÖ Consulta de Refei√ß√µes</div>

  <!-- FILTROS -->
  <div class="card p-3 mb-4">
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label>Matr√≠cula</label>
        <input id="matricula" class="form-control" readonly>
      </div>
      <div class="col-6 col-md-3">
        <label>M√™s</label>
        <select id="mes" class="form-select">
          <option value="">Selecione</option>
          <option value="01">Janeiro</option>
          <option value="02">Fevereiro</option>
          <option value="03">Mar√ßo</option>
          <option value="04">Abril</option>
          <option value="05">Maio</option>
          <option value="06">Junho</option>
          <option value="07">Julho</option>
          <option value="08">Agosto</option>
          <option value="09">Setembro</option>
          <option value="10">Outubro</option>
          <option value="11">Novembro</option>
          <option value="12">Dezembro</option>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label>Ano</label>
        <select id="ano" class="form-select"></select>
      </div>
      <div class="col-12 col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="buscar()">Buscar</button>
      </div>
    </div>
  </div>

  <!-- CALEND√ÅRIO -->
  <div class="card p-3">
    <div class="calendario-wrapper">
      <div id="tituloMes" class="calendario-titulo"></div>
      <div id="calendario" class="calendario"></div>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="modal fade" id="modalDia" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes do Dia</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalConteudo"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const matricula = localStorage.getItem("matricula");
document.getElementById("matricula").value = matricula;

const mesesNome = [
  "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
  "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
];

const anoAtual = new Date().getFullYear();
const anoSelect = document.getElementById("ano");
for (let a = anoAtual; a >= anoAtual - 5; a--) {
  anoSelect.innerHTML += `<option value="${a}">${a}</option>`;
}

let dadosMes = [];

async function buscar() {
  const mes = document.getElementById("mes").value;
  const ano = document.getElementById("ano").value;

  if (!mes || !ano) return alert("Selecione m√™s e ano");

  document.getElementById("tituloMes").innerText =
    `${mesesNome[mes - 1]} / ${ano}`;

  const resp = await fetch(
    `https://long-hall-0aaa.pedro-fillype.workers.dev/buscar?matricula=${matricula}&mes=${mes}&ano=${ano}`
  );

  dadosMes = await resp.json();
  montarCalendario();
}

function montarCalendario() {
  const cal = document.getElementById("calendario");
  cal.innerHTML = "";

  const mes = document.getElementById("mes").value;
  const ano = document.getElementById("ano").value;

  const primeiroDia = new Date(ano, mes - 1, 1);
  const ultimoDia = new Date(ano, mes, 0).getDate();

  const mapa = {};
  dadosMes.forEach(r => {
    const dia = Number(r.datauso.split("-")[2]);
    if (!mapa[dia]) mapa[dia] = [];
    mapa[dia].push(r);
  });

  for (let i = 0; i < primeiroDia.getDay(); i++) {
    cal.innerHTML += `<div></div>`;
  }

  for (let d = 1; d <= ultimoDia; d++) {
    if (mapa[d]) {
      const tipos = mapa[d]
        .map(r => r.tiporefeicao === "ALMOCO" ? "üçΩÔ∏è Almo√ßo" : "üåô Janta")
        .join("<br>");

      cal.innerHTML += `
        <div class="dia registrado" onclick="abrirDia(${d})">
          ${d}
          <span class="refeicao">${tipos}</span>
        </div>`;
    } else {
      cal.innerHTML += `<div class="dia">${d}</div>`;
    }
  }
}

function abrirDia(dia) {
  const registros = dadosMes.filter(r =>
    Number(r.datauso.split("-")[2]) === dia
  );

  let html = "";
  registros.forEach(r => {
    html += `
      <div class="border rounded p-2 mb-2">
        <b>${r.tiporefeicao === "ALMOCO" ? "üçΩÔ∏è Almo√ßo" : "üåô Janta"}</b><br>
        Sequ√™ncia: ${r.sequencia}<br>
        Hor√°rio: ${r.horario}<br>
        Localidade: ${r.localidade}<br>
        Observa√ß√£o: ${r.observacao || "-"}
      </div>`;
  });

  document.getElementById("modalConteudo").innerHTML = html;
  new bootstrap.Modal(document.getElementById("modalDia")).show();
}
</script>

</body>
</html>
