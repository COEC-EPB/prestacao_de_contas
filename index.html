<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presta√ß√£o de Contas - ADD</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --energisa-blue: #0097CE;
  --energisa-blue-dark: #0079a6;
  --energisa-orange: #F36F21;
  --bg-soft: #eef6fa;
  --bg-white: #ffffff;
}

body {
  font-family: "Segoe UI", Roboto, sans-serif;
  background: var(--bg-soft);
  margin: 0;
}

/* HEADER */
.header {
  background: var(--energisa-blue);
  color: white;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logout-btn {
  background: var(--energisa-orange);
  border: none;
  padding: 10px 14px;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-weight: 600;
}

/* CARD */
.card {
  max-width: 900px;
  margin: 30px auto;
  padding: 28px;
  background: var(--bg-white);
  border-radius: 14px;
}

h1 {
  text-align: center;
  color: var(--energisa-blue-dark);
}

form { display: grid; gap: 15px; }

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
}
@media(max-width: 720px) {
  .row { grid-template-columns: 1fr; }
}

input, select, textarea {
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  background: var(--energisa-blue);
  color: white;
  border: none;
  padding: 14px;
  font-weight: 700;
  border-radius: 10px;
  cursor: pointer;
}

.small {
  background: var(--energisa-orange);
  padding: 10px;
  font-size: 13px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h2><i class="bi bi-file-earmark-text"></i> Presta√ß√£o de Contas - ADD</h2>
  <button class="logout-btn" onclick="logout()">
    <i class="bi bi-box-arrow-right"></i> Sair
  </button>
</div>

<div class="card">
  <h1>FORMUL√ÅRIO</h1>

  <form id="addForm">
    <div class="row">
      <div>
        <label>Nome *</label>
        <input id="nome" required>
      </div>
      <div>
        <label>Email *</label>
        <input id="email" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Regional *</label>
        <select id="regional" required>
          <option value="">Selecione...</option>
          <option>LESTE</option>
          <option>CENTRO</option>
          <option>OESTE</option>
        </select>
      </div>
      <div>
        <label>Polo *</label>
        <select id="polo" required>
          <option value="">Selecione...</option>
          <option>Jo√£o Pessoa</option>
          <option>Campina Grande</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Matr√≠cula *</label>
        <input id="matricula" required>
      </div>
      <div>
        <label>Data de Uso *</label>
        <input type="date" id="datauso" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tipo de Refei√ß√£o *</label>
        <select id="tiporefeicao" required>
          <option value="">Selecione...</option>
          <option>ALMO√áO</option>
          <option>JANTA</option>
          <option>EXTRA</option>
        </select>
      </div>
      <div>
        <label>Hor√°rio *</label>
        <input type="time" id="horario" required>
      </div>
    </div>

    <div>
      <label>Local *</label>
      <input id="localidade" required>
    </div>

    <div class="row">
      <div>
        <label>Localiza√ß√£o (opcional)</label>
        <button type="button" id="btnGeo" class="small">Obter Localiza√ß√£o</button>
      </div>
      <div>
        <label>GPS</label>
        <input id="geo" readonly>
      </div>
    </div>

    <button id="btnSubmit">Enviar Registro</button>
  </form>
</div>

<script>
/* LOGOUT */
function logout() {
  localStorage.clear();
  window.location.href = "https://coec-epb.github.io/login/";
}

/* INICIALIZA√á√ÉO */
document.addEventListener("DOMContentLoaded", async () => {

  const matriculaSalva = localStorage.getItem("matricula");
  if (!matriculaSalva) {
    alert("Fa√ßa login novamente.");
    logout();
    return;
  }

  document.getElementById("matricula").value = matriculaSalva;
  document.getElementById("matricula").readOnly = true;

  /* üîπ LIMITE DE 5 DIAS */
  const dataUso = document.getElementById("datauso");
  const hoje = new Date();
  const max = new Date();
  max.setDate(hoje.getDate() + 4);

  dataUso.min = hoje.toISOString().slice(0,10);
  dataUso.max = max.toISOString().slice(0,10);
});

/* GEOLOCALIZA√á√ÉO */
document.getElementById("btnGeo").onclick = () => {
  const geo = document.getElementById("geo");
  navigator.geolocation.getCurrentPosition(pos => {
    geo.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
  });
};

/* SUBMIT */
document.getElementById("addForm").addEventListener("submit", async e => {
  e.preventDefault();

  const btn = document.getElementById("btnSubmit");
  btn.disabled = true;
  btn.innerText = "Enviando...";

  const get = id => document.getElementById(id).value;

  /* VALIDA√á√ÉO EXTRA DOS 5 DIAS */
  const dataSel = new Date(get("datauso"));
  const limite = new Date();
  limite.setDate(limite.getDate() + 4);

  if (dataSel > limite) {
    alert("Voc√™ s√≥ pode registrar at√© 5 dias a partir de hoje.");
    btn.disabled = false;
    btn.innerText = "Enviar Registro";
    return;
  }

  const fd = new FormData();
  [
    "nome","email","regional","polo","matricula","datauso",
    "tiporefeicao","horario","localidade","geo"
  ].forEach(id => fd.append(id, get(id)));

  try {
    const resp = await fetch(
      "https://long-hall-0aaa.pedro-fillype.workers.dev/submit",
      { method: "POST", body: fd }
    );

    const json = await resp.json();
    if (!resp.ok || json.ok === false) throw new Error(json.error);

    alert("Registro enviado com sucesso!");

    /* üîÑ REFRESH AUTOM√ÅTICO */
    location.reload();

  } catch (err) {
    alert("Erro ao enviar: " + err.message);
    btn.disabled = false;
    btn.innerText = "Enviar Registro";
  }
});
</script>

</body>
</html>
