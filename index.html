<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presta√ß√£o de Contas - ADD</title>
<style>
  body{font-family: "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg,#e3f2fd,#fff); padding:24px; color:#333;}
  .card{max-width:900px;margin:18px auto;padding:20px;border-radius:12px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
  h1{text-align:center;color:#0d47a1;margin:6px 0 12px;font-size:20px;text-transform:uppercase;}
  form{display:grid;gap:10px;}
  label{font-weight:600;font-size:14px;}
  input,select,textarea,button{width:100%;padding:12px;border-radius:8px;border:1px solid #cfd8dc;background:#f7f9fc;font-size:15px}
  button{background:#1e88e5;color:#fff;border:none;cursor:pointer;font-weight:700}
  .small{padding:8px;font-size:13px}
  .muted{color:#666;font-size:13px;text-align:center}

  /* === vers√£o final e √∫nica da classe .row === */
  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4px;
    margin-bottom: -4px;
  }

  @media (max-width: 720px) {
    .row {
      grid-template-columns: 1fr;
      gap: 4px;
      margin-bottom: 0;
    }
  }

  /* melhora visual do bot√£o de geo para n√£o ocupar 100% do input quando quiser */
  button.small { width: 100%; box-sizing: border-box; }
</style>
</head>
<body>
  <div class="card">
    <div style="text-align:center">
      <img src="https://upload.wikimedia.org/wikipedia/commons/f/f6/Logo_energisa.png" alt="Energisa" style="max-width:180px;margin-bottom:6px">
      <h1>PRESTA√á√ÉO DE CONTAS - ADD</h1>
    </div>

    <form id="addForm" autocomplete="off">
      <label>Nome *</label>
      <input id="nome" type="text" required>

      <label>Regional *</label>
      <select id="regional" required>
        <option value="">Selecione...</option><option>LESTE</option><option>CENTRO</option><option>OESTE</option>
      </select>

      <label>Polo *</label>
      <select id="polo" required>
        <option value="">Selecione...</option>
        <option>Jo√£o Pessoa</option><option>Itabaiana</option><option>Mamanguape</option><option>Borborema</option>
        <option>Campina Grande</option><option>Monteiro</option><option>Guarabira</option><option>Esperan√ßa</option>
        <option>Itaporanga</option><option>Sousa</option><option>Patos</option><option>Catol√© do Rocha</option>
      </select>

      <div class="row">
        <div>
          <label>Matr√≠cula *</label>
          <input id="matricula" type="text" required>
        </div>
        <div>
          <label>Data do uso *</label>
          <input id="datauso" type="date" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tipo de Refei√ß√£o *</label>
          <select id="tiporefeicao" required>
            <option value="">Selecione...</option>
            <option>ALMO√áO</option><option>JANTA</option><option>EXTRA (AP√ìS DUAS HORAS DO FINAL DA ESCALA) EXCE√á√ÉO</option>
          </select>
        </div>
        <div>
          <label>Hor√°rio *</label>
          <input id="horario" type="time" required>
        </div>
      </div>

      <label>Localidade em que foi usado o ADD *</label>
      <input id="localidade" type="text" required>

      <div class="row">
        <div>
          <label>Solicitar localiza√ß√£o geogr√°fica *</label>
          <button type="button" id="btnGeo" class="small">Obter Localiza√ß√£o</button>
        </div>
        <div>
          <label>Coordenadas *</label>
          <input id="geo" type="text" placeholder="lat, lng" readonly required>
        </div>
      </div>

      <label>Sequ√™ncia do ADD (opcional)</label>
      <input id="sequencia" type="text" placeholder="Ex: 1¬∞, 2¬∞, 3¬∞">

      <div class="row">
        <div>
          <label>N√∫mero da OS / RR / SS (opcional)</label>
          <input id="osrrss" type="text">
        </div>
        <div>
          <label>N√∫mero do ADD (opcional)</label>
          <input id="numeroadd" type="text">
        </div>
      </div>

      <label>Observa√ß√£o sobre a refei√ß√£o (opcional)</label>
      <textarea id="observacao" rows="3"></textarea>

      <button id="btnSubmit" type="submit">Enviar (E-mail + CSV)</button>
      <p class="muted">O e-mail ser√° enviado para: <b>pedro.fillype@energisa.com.br</b></p>
    </form>
  </div>

<script>
/* --------------------------
 CONFIG: EmailJS
---------------------------*/
const CONFIG = {
  EMAILJS_USER_ID: "DOOkPk4Rqm1NZhIWO",
  EMAILJS_SERVICE_ID: "service_915mowg",
  EMAILJS_TEMPLATE_ID: "template_lirn629",
  EMAIL_TO: "pedro.fillype@energisa.com.br"
};

function slugifyName(s) {
  return String(s||"").trim().replace(/\s+/g, "_").replace(/[^\w\-]/g, "");
}

/* wait DOM */
document.addEventListener("DOMContentLoaded", () => {
  // pegar elementos de forma expl√≠cita (corrige o problema principal)
  const form = document.getElementById("addForm");
  const btnGeo = document.getElementById("btnGeo");
  const btnSubmit = document.getElementById("btnSubmit");

  const nome = document.getElementById("nome");
  const regional = document.getElementById("regional");
  const polo = document.getElementById("polo");
  const matricula = document.getElementById("matricula");
  const datauso = document.getElementById("datauso");
  const tiporefeicao = document.getElementById("tiporefeicao");
  const horario = document.getElementById("horario");
  const localidade = document.getElementById("localidade");
  const geo = document.getElementById("geo");
  const sequencia = document.getElementById("sequencia");
  const osrrss = document.getElementById("osrrss");
  const numeroadd = document.getElementById("numeroadd");
  const observacao = document.getElementById("observacao");

  /* --------------------------
    GEOLOCATION
  ---------------------------*/
  btnGeo.addEventListener("click", () => {
    if (!navigator.geolocation) { alert("Geolocaliza√ß√£o n√£o suportada."); return; }
    btnGeo.innerText = "Capturando...";
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      geo.value = `${lat}, ${lng}`;
      btnGeo.innerText = "Obter Localiza√ß√£o";
    }, (err)=>{
      console.error(err);
      alert("Erro ao capturar localiza√ß√£o: " + (err.message || "permission denied"));
      btnGeo.innerText = "Obter Localiza√ß√£o";
    }, {enableHighAccuracy:true, timeout:10000});
  });

  /* --------------------------
    CSV helpers
  ---------------------------*/
  function gerarCSVString(obj) {
    const headers = ["timestamp","nome","regional","polo","matricula","datauso","tiporefeicao","horario","localidade","localizacao_gps","sequencia","osrrss","numeroadd","observacao"];
    const linha = [
      obj.timestamp,obj.nome,obj.regional,obj.polo,obj.matricula,obj.datauso,
      obj.tiporefeicao,obj.horario,obj.localidade,obj.localizacao_gps,obj.sequencia,
      obj.osrrss,obj.numeroadd,obj.observacao
    ];
    const q = v => `"${String(v === undefined || v === null ? "" : v).replace(/"/g,'""')}"`;
    return headers.map(q).join(",") + "\n" + linha.map(q).join(",");
  }

  function baixarCSV(csvString, filename) {
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    return url;
  }

  /* --------------------------
    EmailJS loader + sender
  ---------------------------*/
  let emailjsReady = false;
  async function ensureEmailJS() {
    if (emailjsReady && window.emailjs) return;
    if (!window.emailjs) {
      await new Promise(res=>{
        const sc=document.createElement("script");
        sc.src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
        sc.onload = res;
        sc.onerror = ()=>{ res(); console.warn("Falha ao carregar EmailJS"); };
        document.head.appendChild(sc);
      });
    }
    if (window.emailjs && !emailjsReady) {
      try { emailjs.init(CONFIG.EMAILJS_USER_ID); } catch(e) { console.warn("emailjs.init falhou:", e); }
      emailjsReady = true;
    }
  }

  async function enviarEmailEmailJS(payload, csvString, csvUrl, csvFilename) {
    await ensureEmailJS();
    if (!window.emailjs) throw new Error("EmailJS n√£o carregado");

    const plain = `
Nova presta√ß√£o de contas registrada:

Nome: ${payload.nome}
Regional: ${payload.regional}
Polo: ${payload.polo}
Matr√≠cula: ${payload.matricula}
Data do uso: ${payload.datauso}
Tipo de refei√ß√£o: ${payload.tiporefeicao}
Hor√°rio: ${payload.horario}
Localidade: ${payload.localidade}
Localiza√ß√£o GPS: ${payload.localizacao_gps}
Sequ√™ncia: ${payload.sequencia}
OS/RR/SS: ${payload.osrrss}
N√∫mero do ADD: ${payload.numeroadd}
Observa√ß√£o: ${payload.observacao}
Timestamp: ${payload.timestamp}
    `;

    const html = `
      <div style="font-family:Arial,Helvetica,sans-serif">
        <h3>Nova presta√ß√£o de contas - ADD</h3>
        <pre>${plain}</pre>
        <p>CSV gerado (anexo no corpo):</p>
        <pre>${csvString}</pre>
      </div>
    `;

    return emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, {
      to_email: CONFIG.EMAIL_TO,
      subject: `Presta√ß√£o ADD - ${payload.nome} - ${payload.datauso}`,
      plain_body: plain,
      html_body: html,
      csv_content: csvString,
      filename: csvFilename
    });
  }

  /* --------------------------
     FORM submit
  ---------------------------*/
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    btnSubmit.disabled = true;
    btnSubmit.innerText = "Enviando...";

    try {
      const payload = {
        timestamp: new Date().toISOString(),
        nome: nome.value.trim(),
        regional: regional.value,
        polo: polo.value,
        matricula: matricula.value.trim(),
        datauso: datauso.value,
        tiporefeicao: tiporefeicao.value,
        horario: horario.value,
        localidade: localidade.value.trim(),
        localizacao_gps: geo.value,
        sequencia: sequencia.value.trim(),
        osrrss: osrrss.value.trim(),
        numeroadd: numeroadd.value.trim(),
        observacao: observacao.value.trim()
      };

      // valida√ß√£o m√≠nima
      if (!payload.nome || !payload.matricula || !payload.datauso) {
        alert("Preencha os campos obrigat√≥rios (Nome, Matr√≠cula, Data do uso).");
        btnSubmit.disabled = false;
        btnSubmit.innerText = "Enviar (E-mail + CSV)";
        return;
      }

      const csv = gerarCSVString(payload);
      const nomeSanit = slugifyName(payload.nome || "usuario");
      const dataCurta = payload.timestamp.slice(0,10);
      const csvFilename = `prestacao_${nomeSanit}_${dataCurta}.csv`;

      const csvUrl = baixarCSV(csv, csvFilename);

      // enviar email - pode falhar se template/service n√£o existir ou campos diferentes
      try {
        await enviarEmailEmailJS(payload, csv, csvUrl, csvFilename);
        alert("E-mail enviado com sucesso üëç (e CSV baixado).");
      } catch (err) {
        console.error("Erro ao enviar email via EmailJS:", err);
        alert("Falha ao enviar e-mail. Verifique console e configura√ß√£o do EmailJS.");
      }

      // liberar objectURL depois de alguns segundos
      setTimeout(()=> {
        try { URL.revokeObjectURL(csvUrl); } catch(e){/*ignore*/}
      }, 8000);

      // opcional: resetar form
      form.reset();

    } catch (err) {
      console.error(err);
      alert("Ocorreu um erro. Veja console para detalhes.");
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.innerText = "Enviar (E-mail + CSV)";
    }
  });

}); // DOMContentLoaded
</script>
</body>
</html>
