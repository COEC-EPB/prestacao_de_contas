<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prestação de Contas - ADD</title>

<style>
  * { box-sizing: border-box; } 
  body{font-family:"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#e3f2fd,#fff);
       padding:24px;color:#333;margin:0;}
  .card{max-width:900px;margin:18px auto;padding:20px;border-radius:12px;background:#fff;
        box-shadow:0 6px 20px rgba(0,0,0,0.08);}
  h1{text-align:center;color:#0d47a1;margin:6px 0 12px;font-size:20px;text-transform:uppercase;}
  form{display:grid;gap:10px;}
  label{font-weight:600;font-size:14px;margin-bottom:4px;display:block;}

  input,select,textarea,button{
    width:100%;padding:12px;border-radius:8px;border:1px solid #cfd8dc;
    background:#f7f9fc;font-size:15px;outline:none;
  }
  input:focus,select:focus,textarea:focus{border-color:#1e88e5;background:#fff;}

  button{background:#1e88e5;color:#fff;border:none;cursor:pointer;font-weight:700;transition:0.3s;}
  button:hover{background:#1565c0;}

  .row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
    margin-bottom:2px;
  }
  @media(max-width:720px){
    .row{grid-template-columns:1fr;gap:10px;}
    body{padding:12px;}
  }

  .small{padding:8px;font-size:13px}
  .muted{color:#666;font-size:13px;text-align:center}
</style>
</head>
<body>

<div class="card">
  <h1>PRESTAÇÃO DE CONTAS - ADD</h1>

  <!-- FORMULÁRIO WEB3FORMS -->
  <form id="addForm" action="https://api.web3forms.com/submit" method="POST">

    <!-- Chave de acesso Web3Forms -->
    <input type="hidden" name="access_key" value="89885c8d-355e-4b5f-8fe6-d2dfd2e7aff9">

    <!-- Campo automático que envia o conteúdo do CSV como texto -->
    <input type="hidden" name="csv_content" id="csv_content">

    <!-- Email destino -->
    <input type="hidden" name="to" value="pedro.fillype@energisa.com.br">

    <!-- Campos reais -->
    <div>
      <label>Nome *</label>
      <input id="nome" name="nome" type="text" required>
    </div>

    <div class="row">
      <div>
        <label>Regional *</label>
        <select id="regional" name="regional" required>
          <option value="">Selecione...</option><option>LESTE</option><option>CENTRO</option><option>OESTE</option>
        </select>
      </div>
      <div>
        <label>Polo *</label>
        <select id="polo" name="polo" required>
          <option value="">Selecione...</option>
          <option>João Pessoa</option><option>Itabaiana</option><option>Mamanguape</option><option>Borborema</option>
          <option>Campina Grande</option><option>Monteiro</option><option>Guarabira</option><option>Esperança</option>
          <option>Itaporanga</option><option>Sousa</option><option>Patos</option><option>Catolé do Rocha</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Matrícula *</label>
        <input id="matricula" name="matricula" type="text" required>
      </div>
      <div>
        <label>Data do uso *</label>
        <input id="datauso" name="datauso" type="date" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tipo de Refeição *</label>
        <select id="tiporefeicao" name="tiporefeicao" required>
          <option value="">Selecione...</option>
          <option>ALMOÇO</option><option>JANTA</option>
          <option>EXTRA (APÓS DUAS HORAS DO FINAL DA ESCALA)</option>
        </select>
      </div>
      <div>
        <label>Horário *</label>
        <input id="horario" name="horario" type="time" required>
      </div>
    </div>

    <div>
      <label>Localidade em que foi usado o ADD *</label>
      <input id="localidade" name="localidade" type="text" required>
    </div>

    <div class="row">
      <div>
        <label>Solicitar localização geográfica *</label>
        <button type="button" id="btnGeo" class="small">Obter Localização</button>
      </div>
      <div>
        <label>Coordenadas *</label>
        <input id="geo" name="localizacao_gps" type="text" placeholder="lat, lng" readonly required>
      </div>
    </div>

    <div>
      <label>Sequência do ADD (opcional)</label>
      <input id="sequencia" name="sequencia" type="text">
    </div>

    <div class="row">
      <div>
        <label>Número da OS / RR / SS (opcional)</label>
        <input id="osrrss" name="osrrss" type="text">
      </div>
      <div>
        <label>Número do ADD (opcional)</label>
        <input id="numeroadd" name="numeroadd" type="text">
      </div>
    </div>

    <div>
      <label>Observação (opcional)</label>
      <textarea id="observacao" name="observacao" rows="3"></textarea>
    </div>

    <button id="btnSubmit" type="submit">Enviar (E-mail + CSV)</button>

    <p class="muted">O e-mail será enviado para: <b>pedro.fillype@energisa.com.br</b></p>
  </form>
</div>

<script>
/* GEOLOCATION */
document.getElementById("btnGeo").addEventListener("click", ()=>{
  if(!navigator.geolocation){ alert("Geolocalização não suportada."); return; }

  const btn = document.getElementById("btnGeo");
  btn.innerText = "Capturando...";

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    document.getElementById("geo").value = `${lat}, ${lng}`;
    btn.innerText = "Localização OK!";
    btn.style.background = "#43a047";
  },()=>{
    btn.innerText="Obter Localização";
    alert("Ative o GPS e tente novamente.");
  },{enableHighAccuracy:true,timeout:10000});
});

/* CSV */
function gerarCSV(obj){
  const headers = [
    "timestamp","nome","regional","polo","matricula","datauso",
    "tiporefeicao","horario","localidade","localizacao_gps","sequencia",
    "osrrss","numeroadd","observacao"
  ];

  const linha = [
    obj.timestamp,obj.nome,obj.regional,obj.polo,obj.matricula,obj.datauso,
    obj.tiporefeicao,obj.horario,obj.localidade,obj.localizacao_gps,
    obj.sequencia,obj.osrrss,obj.numeroadd,obj.observacao
  ];

  const q = v => `"${String(v ?? "").replace(/"/g,'""')}"`;
  return headers.map(q).join(",") + "\n" + linha.map(q).join(",");
}

/* Download CSV */
function baixarCSV(csvString, filename){
  const blob = new Blob(["\uFEFF"+csvString],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}

/* SUBMIT */
document.getElementById("addForm").addEventListener("submit", (e)=>{
  const btn = document.getElementById("btnSubmit");
  btn.innerText = "Processando...";
  btn.disabled = true;

  const payload = {
    timestamp:new Date().toISOString(),
    nome: nome.value.trim(),
    regional: regional.value,
    polo: polo.value,
    matricula: matricula.value.trim(),
    datauso: datauso.value,
    tiporefeicao: tiporefeicao.value,
    horario: horario.value,
    localidade: localidade.value.trim(),
    localizacao_gps: geo.value,
    sequencia: sequencia.value.trim(),
    osrrss: osrrss.value.trim(),
    numeroadd: numeroadd.value.trim(),
    observacao: observacao.value.trim()
  };

  const csv = gerarCSV(payload);
  const filename = `ADD_${payload.nome.replace(/\s+/g,"_")}_${payload.datauso}.csv`;

  baixarCSV(csv, filename);

  // Coloca o CSV como texto para enviar no e-mail
  document.getElementById("csv_content").value = csv;

  btn.innerText = "Enviando...";
});
</script>

</body>
</html>
